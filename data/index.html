<!DOCTYPE html>
<html>
<head>
  <title>Rancilio Silvia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css" media="all">
  <link rel="stylesheet" href="prophet.min.css" media="all">
</head>
<body>
  <h1>Silvia</h1>
  <div class="metrics">
    <p>
      <span class="sensor-labels">Boiler Status:</span>
      <span id="boilerStatus">N/A</span>
    </p>
    <p>
      <span class="sensor-labels">Target Temperature:</span>
      <span id="targetTemperature">N/A</span>
      <sup class="units">&deg;C</sup>
    </p>
    <p>
      <span class="sensor-labels">Temperature:</span>
      <span id="temperature">N/A</span>
      <sup class="units">&deg;C</sup>
      <span class="sensor-labels">Pressure:</span>
      <span id="pressure">N/A</span>
      <sup class="units">bar</sup>
    </p>   
  </div>
  <div class="chart-container">
    <svg class="chart" id="chart"></svg>
  </div>
  <div class="config-wrapper">
    <div class="row">
      <div class="col">
        <label for="configTargetTemperature">Target Temperature</label>
        <input type="number" inputmode="numeric" name="configTargetTemperature" id="configTargetTemperature" step="1" />
      </div>
      <div class="col">
        <label for="configOvershoot">Temperature Overshoot</label>
          <input type="number" inputmode="numeric" name="configOvershoot" id="configOvershoot" step="0.1" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <h3>Normal PID</h3>
        <label for="configP">P</label>
        <input type="number" inputmode="numeric" name="configP" id="configP" step="0.1" />
        <label for="configI">I</label>
        <input type="number" inputmode="numeric" name="configI" id="configI" step="0.1" />
        <label for="configD">D</label>
        <input type="number" inputmode="numeric" name="configD" id="configD" step="0.1" />
      </div>
      <div class="col">
        <h3>Adaptive PID</h3>
        <label for="configAP">aP</label>
        <input type="number" inputmode="numeric" name="configAP" id="configAP" step="0.1" />
        <label for="configAI">aI</label>
        <input type="number" inputmode="numeric" name="configAI" id="configAI" step="0.1" />
        <label for="configAD">aD</label>
        <input type="number" inputmode="numeric" name="configAD" id="configAD" step="0.1" />
      </div>
    </div>
    <button id="save" type="button" onclick="updateConfig();">Save</button>
  </div>
  <ul class="prophet"></ul>
</body>
<script src="d3.v7.min.js"></script>
<script type="text/javascript" src="prophet.min.js"></script>
<script>
var margin = { top: 20, right: 20, bottom: 30, left: 50 };
var width = window.innerWidth - margin.left - margin.right;
var height = Math.floor((window.innerHeight - 100) / 2) - margin.top - margin.bottom;
var x = d3.scaleTime().range([0, width]);
var y1 = d3.scaleLinear().range([height, 0]);
var y2 = d3.scaleLinear().range([height, 0]);

var xAxis = d3.axisBottom(x);
var yAxis1 = d3.axisLeft(y1);
var yAxis2 = d3.axisRight(y2);

var temperatureLine = d3.line()
  .x(function (d) { return x(d.time); })
  .y(function (d) { return y1(d.temperature); });

var pressureLine = d3.line()
  .x(function (d) { return x(d.time); })
  .y(function (d) { return y2(d.pressure); });

var svg = d3.select("#chart")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var data = [];
var time = new Date();

x.domain(d3.extent(data, function (d) { return d.time; }));
  y1.domain([0, 150]);
  y2.domain([0, 15]);

  svg.append("g")
    .attr("class", "x-axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

  svg.append("g")
    .attr("class", "y-axis temperature-axis")
    .call(yAxis1)
    .append("text")
    .attr("fill", "#ffffff")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", "0.71em")
    .style("text-anchor", "end")
    .text("Temperature (Â°C)");

  svg.append("g")
    .attr("class", "y-axis pressure-axis")
    .attr("transform", "translate(" + width + ",0)")
    .call(yAxis2)
    .append("text")
    .attr("fill", "#ffffff")
    .attr("transform", "rotate(-90)")
    .attr("y", -12)
    .attr("dy", "0.71em")
    .style("text-anchor", "end")
    .text("Pressure (bar)");

  var temperaturePath = svg.append("path")
    .datum(data)
    .attr("class", "temperature-line")
    .attr("fill", "none")
    .attr("stroke", "#ff5722")
    .attr("stroke-width", 2)
    .attr("d", temperatureLine);

  var pressurePath = svg.append("path")
    .datum(data)
    .attr("class", "pressure-line")
    .attr("fill", "none")
    .attr("stroke", "#03a9f4")
    .attr("stroke-width", 2)
    .attr("d", pressureLine);

const currentTempEl = document.getElementById('temperature');
const targetTempEl = document.getElementById('targetTemperature');
const currentPresEl = document.getElementById('pressure');
const boilerStatusEl = document.getElementById('boilerStatus');

const updateStatus = () => {
  time = new Date();
  fetch('/status')
  .then(res => res.json())
  .then(val => {
    data.push({ time: time, temperature: val.temperature, pressure: val.pressure });
    currentTempEl.innerHTML = val.temperature;
    targetTempEl.innerHTML = val.targetTemperature;
    currentPresEl.innerHTML = val.pressure;
    boilerStatusEl.innerHTML = val.boilerStatus ? 'On' : 'Off';
    setTimeout(updateStatus, 500);
  }).catch(err => {
    console.error('Error getting status', err);
    setTimeout(updateStatus, 500);
  });

  // data.push({ time: time, temperature: val.temperature, pressure: val.pressure });
  if (data.length > width) {
        data.shift();
      }

      x.range([0, width]);
      y1.range([height, 0]);
      y2.range([height, 0]);

      x.domain(d3.extent(data, function (d) { return d.time; }));
      y1.domain([0, d3.max(data, function (d) { return d.temperature; })]);
      y2.domain([0, d3.max(data, function (d) { return d.pressure; })]);

      svg.select(".x-axis")
        .call(xAxis);

      svg.select(".y-axis.temperature-axis")
        .call(yAxis1);

      svg.select(".y-axis.pressure-axis")
        .call(yAxis2);

      temperaturePath.attr("d", temperatureLine);
      pressurePath.attr("d", pressureLine);  
};

const configFields = [];

const getConfig = () => {
  fetch('/config')
  .then(res => res.json())
  .then(config => {
    for(let i in config){
      const field = 'config' + jsUcFirst(i);
      configFields.push(i);
      const element = document.getElementById(field);
      element.value = config[i];
    }
  });
}

const updateConfig = () => {
  const data = new URLSearchParams();
  for(let i of configFields){
    const field = 'config' + jsUcFirst(i);
    const element = document.getElementById(field);
    data.append(i, element.value);
  }
  fetch('/config', {
    method: 'post',
    body: data,
  })
  .then(() => {
    const toast = new Message("Saved", {
      type: 'success'
    });
    toast.show();
  }).catch(err => {
    console.error(err);
    const toast = new Message("Could not save", {
      type: 'error'
    });
    toast.show();
  });
}

const jsUcFirst = (string) => {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

const jsLcFirst = (string) => {
    return string.charAt(0).toLowerCase() + string.slice(1);
}

window.addEventListener('resize', function () {
      width = window.innerWidth - margin.left - margin.right;
      height = Math.floor((window.innerHeight - 100) / 2) - margin.top - margin.bottom;

      d3.select(".chart-container")
        .style("height", "calc(50vh - 50px)");

      svg.attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

      x.range([0, width]);
      y1.range([height, 0]);
      y2.range([height, 0]);

      x.domain(d3.extent(data, function (d) { return d.time; }));
      y1.domain([0, d3.max(data, function (d) { return d.temperature; })]);
      y2.domain([0, d3.max(data, function (d) { return d.pressure; })]);

      svg.select(".x-axis")
        .call(xAxis);

      svg.select(".y-axis.temperature-axis")
        .call(yAxis1);

      svg.select(".y-axis.pressure-axis")
        .call(yAxis2);

      temperaturePath.attr("d", temperatureLine);
      pressurePath.attr("d", pressureLine);
    });

getConfig();
updateStatus();
</script>
</html>
